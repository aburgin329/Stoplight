<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stoplight Control</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    /* Stoplight styling */
    .stoplight {
      width: 100px;
      background-color: black;
      padding: 20px;
      text-align: center;
      border-radius: 10px;
      margin: auto;
    }
    .light {
      width: 50px;
      height: 50px;
      margin: 10px auto;
      border-radius: 50%;
      background-color: gray;
    }
    .red { background-color: red; }
    .yellow { background-color: yellow; }
    .green { background-color: green; }
    
    /* Control sections */
    .control-section {
      margin-top: 30px;
      text-align: center;
    }
    .control-section h2 {
      margin-bottom: 10px;
    }
    hr {
      margin: 30px 0;
    }
    
    /* Modal styling */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    .modal .modal-content {
      background-color: #fff;
      width: 300px;
      margin: 15% auto;
      padding: 20px;
      text-align: center;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .modal button {
      margin: 10px;
      padding: 8px 16px;
    }
    .modal input[type="number"] {
      width: 60px;
      margin: 5px;
    }
    
    /* Additional styling for message modal */
    #message-modal .modal-content {
      width: 250px;
    }
    
    /* Styling for settings modal rows */
    .settings-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 10px 0;
    }
    .settings-row label {
      flex: 0 0 40%;
      text-align: left;
    }
    .settings-row input {
      flex: 0 0 55%;
    }
    
    /* Power off icon styling (upper right corner) */
    #power-off-btn {
      position: fixed;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 32px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1 style="text-align: center;">Stoplight Control</h1>
  
  <!-- Power Off Icon (visible when system is on) -->
  <button id="power-off-btn" title="Turn Off System">⏻</button>
  
  <!-- Main Controls Section -->
  <div id="main-controls">
    <!-- Stoplight display -->
    <div class="stoplight">
      <div id="red-light" class="light"></div>
      <div id="yellow-light" class="light"></div>
      <div id="green-light" class="light"></div>
    </div>
    
    <hr>
    
    <!-- Automatic Controls Section -->
    <div class="control-section auto-controls">
      <h2>Automatic Controls</h2>
      <button id="auto-btn">Start Auto</button>
      <button id="stop-btn">Stop Auto</button>
      <button id="settings-btn">Settings</button>
    </div>
    
    <!-- Manual Controls Section -->
    <div class="control-section manual-controls">
      <h2>Manual Controls</h2>
      <button id="manual-btn">Manual Cycle</button>
    </div>
  </div>
  
  <!-- Off Modal: Appears when system is turned off -->
  <div id="turn-off-modal" class="modal">
    <div class="modal-content">
      <p id="turn-off-message">System is powered off, press power to turn on.</p>
      <button id="turn-on-from-off-btn">Turn On</button>
    </div>
  </div>
  
  <!-- Turn On Confirmation Modal (if needed) -->
  <div id="turn-on-confirm-modal" class="modal">
    <div class="modal-content">
      <p id="turn-on-confirm-message">Are you sure you want to power on the system?</p>
      <div id="turn-on-confirm-buttons">
        <button id="turn-on-confirm-yes">Yes</button>
        <button id="turn-on-confirm-cancel">Cancel</button>
      </div>
    </div>
  </div>
  
  <!-- Stop Confirmation Modal -->
  <div id="confirm-modal" class="modal">
    <div class="modal-content">
      <p id="confirm-message">Are you sure you want to stop?</p>
      <div id="confirm-buttons">
        <button id="confirm-yes">Yes</button>
        <button id="confirm-no">No</button>
      </div>
    </div>
  </div>
  
  <!-- Settings Confirmation Modal -->
  <div id="settings-confirm-modal" class="modal">
    <div class="modal-content">
      <p id="settings-confirm-message">Modifying settings will stop the automation. Do you want to continue?</p>
      <div id="settings-confirm-buttons">
        <button id="settings-confirm-yes">Yes</button>
        <button id="settings-confirm-cancel">Cancel</button>
      </div>
    </div>
  </div>
  
  <!-- Settings Modal -->
  <div id="settings-modal" class="modal">
    <div class="modal-content">
      <h2>Automatic Mode Settings</h2>
      <p>Set durations (in seconds):</p>
      <div class="settings-row">
        <label for="duration-green">Green:</label>
        <input type="number" id="duration-green" value="3" min="0.5" step="0.5">
      </div>
      <div class="settings-row">
        <label for="duration-yellow">Yellow:</label>
        <input type="number" id="duration-yellow" value="2" min="0.5" step="0.5">
      </div>
      <div class="settings-row">
        <label for="duration-red">Red:</label>
        <input type="number" id="duration-red" value="3" min="0.5" step="0.5">
      </div>
      <div id="settings-buttons">
        <button id="settings-save">Save</button>
        <button id="settings-cancel">Cancel</button>
      </div>
    </div>
  </div>
  
  <!-- Message Modal for updates -->
  <div id="message-modal" class="modal">
    <div class="modal-content">
      <p id="message-text"></p>
    </div>
  </div>
  
  <script>
    // Function to update the light display
    function updateLight() {
      $.get("/get_light", function(data) {
        $(".light").removeClass("red yellow green");
        if (data.light !== "off") {
          $("#" + data.light + "-light").addClass(data.light);
        }
      });
    }
    
    // Function to update system UI from /get_system_state
    function updateSystemUI() {
      $.get("/get_system_state", function(data) {
        if (data.system_on) {
          $("#main-controls").show();
          $("#power-off-btn").show();
        } else {
          $("#main-controls").hide();
          $("#power-off-btn").hide();
        }
      });
    }
    
    // Button click handlers:
    
    // Power Off icon click – turns system off and shows off modal
    $("#power-off-btn").click(function() {
      $.post("/turn_off", function(response) {
        updateSystemUI();
        $("#turn-off-modal").fadeIn();
      });
    });
    
    // In off modal, "Turn On" button acts as a power on switch
    $("#turn-on-from-off-btn").click(function() {
      $("#turn-off-modal").fadeOut(function() {
        $("#message-text").text("Powering on...");
        $("#message-modal").fadeIn();
        setTimeout(function() {
          $.post("/turn_on", function(response) {
            updateSystemUI();
            $("#message-modal").fadeOut();
          });
        }, 3000);
      });
    });
    
    // Manual Cycle
    $("#manual-btn").click(function() {
      $.post("/manual_cycle", function() {
        updateLight();
      });
    });
    
    // Start Auto
    $("#auto-btn").click(function() {
      $.post("/start_auto", function() {
        $("#manual-btn").prop("disabled", true);
        $("#auto-btn").prop("disabled", true);
        $("#stop-btn").prop("disabled", false);
      });
    });
    
    // Stop Auto confirmation modal
    $("#stop-btn").click(function() {
      $("#confirm-modal").fadeIn();
    });
    
    $("#confirm-no").click(function() {
      $("#confirm-modal").fadeOut();
    });
    
    $("#confirm-yes").click(function() {
      $.post("/stop_auto", function() {
        $("#manual-btn").prop("disabled", false);
        $("#auto-btn").prop("disabled", false);
        $("#stop-btn").prop("disabled", true);
      });
      $("#confirm-message").text("Stopping stoplight automation...");
      $("#confirm-buttons").hide();
      setTimeout(function() {
        $("#confirm-message").text("Are you sure you want to stop?");
        $("#confirm-buttons").show();
        $("#confirm-modal").fadeOut();
      }, 4000);
    });
    
    // Settings button – confirmation before opening settings modal
    $("#settings-btn").click(function() {
      $("#settings-confirm-modal").fadeIn();
    });
    
    $("#settings-confirm-cancel").click(function() {
      $("#settings-confirm-modal").fadeOut();
    });
    
    $("#settings-confirm-yes").click(function() {
      $.post("/stop_auto", function() {
        $("#manual-btn").prop("disabled", false);
        $("#auto-btn").prop("disabled", false);
        $("#stop-btn").prop("disabled", true);
      });
      $("#settings-confirm-modal").fadeOut(function() {
        $("#settings-modal").fadeIn();
      });
    });
    
    $("#settings-cancel").click(function() {
      $("#settings-modal").fadeOut();
    });
    
    $("#settings-save").click(function() {
      var greenTime = $("#duration-green").val();
      var yellowTime = $("#duration-yellow").val();
      var redTime = $("#duration-red").val();
      
      if (!greenTime || !yellowTime || !redTime) {
        $("#message-text").text("Please enter valid numbers for all durations.");
        $("#message-modal").fadeIn();
        setTimeout(function() {
          $("#message-modal").fadeOut();
        }, 3000);
        return;
      }
      
      var settings = {
        green: parseFloat(greenTime),
        yellow: parseFloat(yellowTime),
        red: parseFloat(redTime)
      };
      
      $.ajax({
        url: "/update_settings",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify(settings),
        success: function(response) {
          $("#settings-modal").fadeOut();
          $("#message-text").text("Settings updated successfully!");
          $("#message-modal").fadeIn();
          setTimeout(function() {
            $("#message-modal").fadeOut();
          }, 3000);
        },
        error: function(xhr) {
          $("#settings-modal").fadeOut();
          var errorMsg = "Error updating settings.";
          if (xhr.responseJSON && xhr.responseJSON.message) {
            errorMsg = xhr.responseJSON.message;
          }
          $("#message-text").text(errorMsg);
          $("#message-modal").fadeIn();
          setTimeout(function() {
            $("#message-modal").fadeOut();
          }, 3000);
        }
      });
    });
    
    // On document ready, update the system UI.
    $(document).ready(function() {
      updateSystemUI();
    });
    
    // Poll for current light status every 500ms.
    setInterval(updateLight, 500);
  </script>
</body>
</html>
